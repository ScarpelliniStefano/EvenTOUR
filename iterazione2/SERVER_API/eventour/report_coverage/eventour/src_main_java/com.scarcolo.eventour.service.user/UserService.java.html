<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">com.scarcolo.eventour (30 dic 2021 11:11:30)</a> &gt; <a href="../../index.html" class="el_group">eventour</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.scarcolo.eventour.service.user</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package com.scarcolo.eventour.service.user;


import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.scarcolo.eventour.functions.Functionalities;
import com.scarcolo.eventour.functions.Mail;
import com.scarcolo.eventour.model.AccountResponse;
import com.scarcolo.eventour.model.admin.Admin;
import com.scarcolo.eventour.model.admin.AdminResponse;
import com.scarcolo.eventour.model.event.Event;
import com.scarcolo.eventour.model.event.EventBookedResponse;
import com.scarcolo.eventour.model.event.EventResponseTour;
import com.scarcolo.eventour.model.event.EventResponseTourComplete;
import com.scarcolo.eventour.model.manager.Manager;
import com.scarcolo.eventour.model.manager.ManagerPlusResponse;
import com.scarcolo.eventour.model.request.Request;
import com.scarcolo.eventour.model.ticketinsp.TicketInsp;
import com.scarcolo.eventour.model.ticketinsp.TicketInspResponse;
import com.scarcolo.eventour.model.user.AddUserRequest;
import com.scarcolo.eventour.model.user.EditUserRequest;
import com.scarcolo.eventour.model.user.User;
import com.scarcolo.eventour.model.user.UserResponse;
import com.scarcolo.eventour.repository.admin.AdminRepository;
import com.scarcolo.eventour.repository.booking.BookingRepository;
import com.scarcolo.eventour.repository.event.EventRepository;
import com.scarcolo.eventour.repository.manager.ManagerRepository;
import com.scarcolo.eventour.repository.manager.RequestRepository;
import com.scarcolo.eventour.repository.ticketisp.TicketInspRepository;
import com.scarcolo.eventour.repository.user.UserRepository;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;


// TODO: Auto-generated Javadoc
/**
 * The Class UserService.
 */
@Service
<span class="fc" id="L49">public class UserService {</span>

	/** The user repository. */
    @Autowired
    private UserRepository userRepository;
	
	/** The manager repository. */
	@Autowired
	private ManagerRepository managerRepository;
	
	/** The admin repository. */
	@Autowired
	private AdminRepository adminRepository;
	
	/** The request repository. */
	@Autowired
	private RequestRepository requestRepository;
	
	/** The ticket inspectors repository. */
	@Autowired
	private TicketInspRepository ticketInspRepository;
	
	/** The event repository. */
	@Autowired
	private EventRepository eventRepository;
	
	/** The booking repository. */
	@Autowired
	private BookingRepository bookingRepository;

   
    /**
     * Add a user.
     *
     * @param request the request of new user
     * @return the response entity with user created
     */
    public ResponseEntity&lt;UserResponse&gt; add(AddUserRequest request){
    	User user;
		try {
<span class="fc" id="L89">			user = userRepository.save(new User(request));</span>
<span class="fc" id="L90">		} catch (Exception e) {</span>
<span class="fc" id="L91">			return new ResponseEntity&lt;&gt;(HttpStatus.NOT_ACCEPTABLE);</span>
		}
<span class="fc" id="L93">        return new ResponseEntity&lt;&gt;(new UserResponse(user), HttpStatus.OK);</span>
    }

  
    /**
     * Update a user.
     *
     * @param request the request
     * @return the response entity
     */
    public ResponseEntity&lt;UserResponse&gt; update(EditUserRequest request){
<span class="fc" id="L104">        Optional&lt;User&gt; optionalUser = userRepository.findById(request.id);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (optionalUser.isEmpty()) {</span>
<span class="nc" id="L106">            return null;</span>
        }
<span class="fc" id="L108">        User u=optionalUser.get();</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        if(request.dateOfBirth!=null) {</span>
        	try {
<span class="nc" id="L111">				u.setDateOfBirth(Functionalities.convertToDate(request.dateOfBirth));</span>
<span class="nc" id="L112">			} catch (Exception e) {</span>
<span class="nc" id="L113">				return new ResponseEntity&lt;&gt;(HttpStatus.NOT_ACCEPTABLE);</span>
			}
        }
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if(request.sex!=null) {</span>
<span class="nc" id="L117">        	u.setSex(request.sex);</span>
        }
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        if(request.surname!=null) {</span>
<span class="nc" id="L120">        	u.setSurname(request.surname);</span>
        }
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if(request.name!=null) {</span>
<span class="nc" id="L123">        	u.setName(request.name);</span>
        }
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if(request.residence!=null) {</span>
<span class="fc" id="L126">        	u.setResidence(request.residence);</span>
        }
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if(request.types!=null) {</span>
<span class="nc" id="L129">        	u.setTypes(request.types);</span>
        }
<span class="fc" id="L131">        userRepository.save(u);</span>
<span class="fc" id="L132">        return new ResponseEntity&lt;&gt;(new UserResponse(u), HttpStatus.OK);</span>
    }

   
    /**
     * Gets the user by id.
     *
     * @param id the id of user
     * @return the user by id
     */
    public ResponseEntity&lt;UserResponse&gt; getById(String id){
<span class="fc" id="L143">    	Optional&lt;User&gt; userData = userRepository.findById(id);</span>

<span class="pc bpc" id="L145" title="1 of 2 branches missed.">  	  if (userData.isPresent()) {</span>
<span class="fc" id="L146">  	    return new ResponseEntity&lt;&gt;(new UserResponse(userData.get()), HttpStatus.OK);</span>
  	  } else {
<span class="nc" id="L148">  	    return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
  	  }
    }

  
    /**
     * Delete a user.
     *
     * @param id the id
     * @return true, if successful
     */
    public ResponseEntity&lt;Boolean&gt; delete(String id) {
<span class="fc" id="L160">    	Optional&lt;User&gt; optionalUser = userRepository.findById(id);</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (optionalUser.isEmpty()) {</span>
<span class="fc" id="L162">            return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
        }
<span class="fc" id="L164">        List&lt;EventBookedResponse&gt; bookByUser=bookingRepository.findByUserId(optionalUser.get().getId());</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        for(EventBookedResponse book : bookByUser){</span>
<span class="nc" id="L166">        	bookingRepository.deleteById(book.getId());</span>
        }
<span class="fc" id="L168">        userRepository.deleteById(optionalUser.get().getId());</span>
        
<span class="fc" id="L170">        return new ResponseEntity&lt;&gt;(true,HttpStatus.OK);</span>
    }

	/**
	 * Gets all users.
	 *
	 * @return all users
	 */
	public ResponseEntity&lt;List&lt;UserResponse&gt;&gt; getAll() {
		try {
<span class="fc" id="L180">			List&lt;User&gt; users = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L181">			userRepository.findAll().forEach(users::add);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">			if(users.isEmpty()) {</span>
<span class="nc" id="L183">				return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
			}
<span class="fc" id="L185">			List&lt;UserResponse&gt; userR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">			for(User user: users) userR.add(new UserResponse(user));</span>
<span class="fc" id="L187">			return new ResponseEntity&lt;&gt;(userR, HttpStatus.OK);</span>
<span class="nc" id="L188">		}catch(Exception e) {</span>
<span class="nc" id="L189">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}
	
	/**
	 * Gets the account of a given mail/code/username and password.
	 *
	 * @param user the user
	 * @param psw the psw
	 * @return the account
	 */
	public ResponseEntity&lt;AccountResponse&gt; getAccount(String user, String psw) {
		
<span class="fc bfc" id="L202" title="All 2 branches covered.">		if(user.isEmpty()) {</span>
<span class="fc" id="L203">			return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		}
		Object objResp;
		try {
<span class="pc bpc" id="L207" title="1 of 4 branches missed.">			if(user.startsWith(&quot;TI-&quot;) &amp;&amp; user.split(&quot;-&quot;).length==3) {</span>
<span class="fc" id="L208">				List&lt;TicketInsp&gt; tickets = ticketInspRepository.findByCode(user);</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">				if(tickets.size()==0) {</span>
<span class="fc" id="L210">					return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. unregistered ticket inspector&quot;),HttpStatus.OK);</span>
				}else {
<span class="fc bfc" id="L212" title="All 2 branches covered.">					for(TicketInsp ticket : tickets) {</span>
						
<span class="fc bfc" id="L214" title="All 2 branches covered.">						if(Functionalities.getMd5(ticket.getPassword()).equals(psw)) {</span>
<span class="fc" id="L215">							objResp=new TicketInspResponse(ticket);</span>
<span class="fc" id="L216">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;TicketInsp&quot;,objResp),HttpStatus.OK);</span>
						}
					}
<span class="fc" id="L219">					return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. invalid password&quot;),HttpStatus.NON_AUTHORITATIVE_INFORMATION);</span>
				}
			}else {
<span class="fc" id="L222">				List&lt;User&gt; users = userRepository.findByMail(user);</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">				if(users.isEmpty()) {</span>
<span class="fc" id="L224">					users=userRepository.findbyUsername(user);</span>
				}
<span class="fc" id="L226">				List&lt;Manager&gt; managers = managerRepository.findByMail(user);</span>
<span class="fc bfc" id="L227" title="All 4 branches covered.">				if(users.isEmpty()&amp;&amp;managers.isEmpty()) {</span>
<span class="fc" id="L228">					List&lt;Admin&gt; admin=adminRepository.findByMail(user);</span>
<span class="fc bfc" id="L229" title="All 2 branches covered.">					if(admin.isEmpty())</span>
<span class="fc" id="L230">						return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. unregistered user&quot;),HttpStatus.OK);</span>
					else
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">						if(Functionalities.getMd5(admin.get(0).getPassword()).equals(psw)) {</span>
<span class="fc" id="L233">							objResp=new AdminResponse(admin.get(0));</span>
<span class="fc" id="L234">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;Admin&quot;,objResp),HttpStatus.OK);</span>
						}else {
<span class="nc" id="L236">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. invalid password&quot;),HttpStatus.NON_AUTHORITATIVE_INFORMATION);</span>
						}
				}else {
<span class="fc bfc" id="L239" title="All 2 branches covered.">					if(!users.isEmpty()) {</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">						if(Functionalities.getMd5(users.get(0).getPassword()).equals(psw)) {</span>
<span class="fc" id="L241">							objResp=new UserResponse(users.get(0));</span>
<span class="fc" id="L242">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;User&quot;,objResp),HttpStatus.OK);</span>
						}else {
<span class="fc" id="L244">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. invalid password&quot;),HttpStatus.NON_AUTHORITATIVE_INFORMATION);</span>
						}
					}else {
<span class="fc bfc" id="L247" title="All 2 branches covered.">						if(Functionalities.getMd5(managers.get(0).getPassword()).equals(psw)) {</span>
<span class="fc" id="L248">							Request req= requestRepository.findByManagerId(managers.get(0).getId()).get(0);</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">							if(!req.isActive()) {</span>
<span class="nc" id="L250">								return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. no active manager&quot;),HttpStatus.OK);</span>
							}
<span class="fc" id="L252">							LocalDate dateCheck=Functionalities.convertToLocalDate(req.getDateRenewal()).plusYears(1);</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">							if(dateCheck.isAfter(LocalDate.now())) {</span>
<span class="fc" id="L254">								objResp=new ManagerPlusResponse(managers.get(0),req);</span>
<span class="fc" id="L255">								return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;Manager&quot;,objResp),HttpStatus.OK);</span>
							}else {
<span class="nc" id="L257">								return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. renewal date is passed&quot;),HttpStatus.OK);</span>
							}
							
						}else {
<span class="fc" id="L261">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. invalid password&quot;),HttpStatus.NON_AUTHORITATIVE_INFORMATION);</span>
						}
					}
				}
			}
<span class="nc" id="L266">		}catch(Exception e) {</span>
<span class="nc" id="L267">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
		
	}
	
	
	
	
	/**
	 * Gets all booking by id user.
	 *
	 * @param id the id user
	 * @return bookings by id user
	 */
	private List&lt;EventBookedResponse&gt; getByIdUser(String id) {
		try {
<span class="fc" id="L283">			List&lt;EventBookedResponse&gt; eventR=bookingRepository.findByUserId(id);</span>
<span class="fc" id="L284">			return eventR;</span>
<span class="nc" id="L285">		}catch(Exception e) {</span>
			//System.out.println(e);
<span class="nc" id="L287">			return null;</span>
		}
	}
	
	/**
	 * Gets the even tour.
	 *
	 * @param userId the user id
	 * @param n the number of events wanted
	 * @param numPers the number at least of freeSeat to find 
	 * @return the even tour
	 */
	public ResponseEntity&lt;EventResponseTourComplete&gt; getEvenTour(String userId,Integer n, Integer numPers) {
<span class="fc" id="L300">		Optional&lt;User&gt; userData = userRepository.findById(userId);</span>
<span class="fc" id="L301">		User u=null;</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">	  	if (userData.isPresent()) {</span>
<span class="fc" id="L303">	  	    u=userData.get();</span>
<span class="fc" id="L304">	  	} else {</span>
<span class="nc" id="L305">	  	    return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
	  	}
<span class="fc" id="L307">	  	List&lt;EventBookedResponse&gt; bookingData = this.getByIdUser(userId);</span>
		//2.ordinamento dataOra
<span class="fc" id="L309">		List&lt;Event&gt; eventR=eventRepository.findByfreeSeatGreaterThanNumPersone(numPers,Sort.by(&quot;dataOra&quot;).ascending());</span>
		//3.ciclo 
<span class="fc" id="L311">		List&lt;Event&gt; s=new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">		if(bookingData!=null) {</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">			for(int j=0;j&lt;bookingData.size();j++) {</span>
<span class="fc" id="L314">				eventR.remove(bookingData.get(j).getEvent()[0]);</span>
<span class="fc" id="L315">				LocalDate dateE=bookingData.get(j).getEvent()[0].getDataOra().toLocalDate();</span>
<span class="fc" id="L316">				eventR.removeIf(e -&gt; dateE.isEqual(e.getDataOra().toLocalDate()));</span>
			}
		}
<span class="fc" id="L319">		final Double latU=u.getResidence().getLat();</span>
<span class="fc" id="L320">		final Double lngU=u.getResidence().getLng();</span>
		
<span class="fc" id="L322">		List&lt;Event&gt; eventCopy=new ArrayList&lt;&gt;(eventR);</span>
<span class="pc bpc" id="L323" title="2 of 6 branches missed.">		eventCopy.removeIf(event -&gt; (event.getLocation().getLat()==null || event.getLocation().getLng()==null || Functionalities.distance(latU, lngU, event.getLocation().getLat(), event.getLocation().getLng())&gt;50));</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">		if(eventCopy.size()==0) {</span>
<span class="nc" id="L325">			return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		}
<span class="fc" id="L327">		Event eventChoice=eventCopy.get(0);</span>
<span class="fc" id="L328">		Double distSel=0d;</span>
<span class="fc" id="L329">		Double peso=Double.MAX_VALUE;</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">		for(int i=0;i&lt;eventCopy.size();i++) {</span>
<span class="fc" id="L331">			Double distEv=Functionalities.distance(latU, lngU, eventCopy.get(i).getLocation().getLat(), eventCopy.get(i).getLocation().getLng());</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">			for(int j=0;j&lt;eventCopy.get(i).getTypes().length;j++) {</span>
<span class="fc bfc" id="L333" title="All 2 branches covered.">				for(String k: u.getTypes()) {</span>
<span class="pc bpc" id="L334" title="3 of 4 branches missed.">						if((s.isEmpty() || !s.get(s.size()-1).getDataOra().toLocalDate().isEqual(eventCopy.get(i).getDataOra().toLocalDate()))) {</span>
							//controllo data
							
<span class="fc bfc" id="L337" title="All 2 branches covered.">							if(eventCopy.get(i).getTypes()[j].toString().equalsIgnoreCase(k.toString())) {</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">								if(peso&gt;(1*(0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*(distEv)))) {</span>
<span class="fc" id="L339">									eventChoice=eventCopy.get(i);</span>
<span class="fc" id="L340">									distSel=distEv;</span>
									//System.out.println(&quot;nomeSel:&quot;+eventCopy.get(i).getTitle()+&quot; tipUs:&quot;+k.toString()+&quot; tipSel:&quot;+eventCopy.get(i).getTypes()[j].toString()+&quot; dist:&quot;+distSel+&quot; price:&quot;+eventCopy.get(i).getPrice());
<span class="fc" id="L342">									peso=0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*distEv;</span>
								}
<span class="fc bfc" id="L344" title="All 2 branches covered.">							}else if(Functionalities.similType(eventCopy.get(i).getTypes()[j],k)){</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">								if(peso&gt;(1.25*(0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*distEv))) {</span>
<span class="fc" id="L346">									eventChoice=eventCopy.get(i);</span>
<span class="fc" id="L347">									distSel=distEv;</span>
									//System.out.println(&quot;nomeSel:&quot;+eventCopy.get(i).getTitle()+&quot; tipUs:&quot;+k.toString()+&quot; tipSel:&quot;+eventCopy.get(i).getTypes()[j].toString()+&quot; dist:&quot;+distSel+&quot; price:&quot;+eventCopy.get(i).getPrice());
<span class="fc" id="L349">									peso=1.5*(0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*distEv);</span>
								}
							}
						}
				}
			}
		}
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">		if(eventChoice==null) {</span>
<span class="nc" id="L357">			return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		}
<span class="fc" id="L359">		s.add(eventChoice);</span>
<span class="fc" id="L360">		boolean choiceNull=false;</span>
<span class="pc bpc" id="L361" title="1 of 4 branches missed.">		while(s.size()&lt;n &amp;&amp; !choiceNull) {</span>
<span class="fc" id="L362">			eventR.remove(eventChoice);</span>
<span class="fc" id="L363">			eventCopy=new ArrayList&lt;&gt;(eventR);</span>
<span class="fc" id="L364">			final Double latRef=s.get(s.size()-1).getLocation().getLat();</span>
<span class="fc" id="L365">			final Double lngRef=s.get(s.size()-1).getLocation().getLng();</span>
<span class="pc bpc" id="L366" title="2 of 4 branches missed.">			eventCopy.removeIf(event -&gt; (event.getLocation().getLat()==null || event.getLocation().getLng()==null || </span>
<span class="fc bfc" id="L367" title="All 2 branches covered.">											Functionalities.distance(latRef, lngRef, event.getLocation().getLat(), event.getLocation().getLng())&gt;50 ||</span>
<span class="fc bfc" id="L368" title="All 4 branches covered.">											event.getDataOra().isBefore(s.get(s.size()-1).getDataOra()) || event.getDataOra().isAfter(s.get(s.size()-1).getDataOra().plusWeeks(4))));</span>
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">			if(eventCopy.size()==0) {</span>
<span class="nc" id="L370">				choiceNull=true;</span>
<span class="nc" id="L371">			}else {</span>
<span class="fc" id="L372">				eventChoice=eventCopy.get(0);</span>
<span class="fc" id="L373">				peso=Double.MAX_VALUE;</span>
<span class="fc bfc" id="L374" title="All 2 branches covered.">				for(int i=0;i&lt;eventCopy.size();i++) {</span>
<span class="fc" id="L375">					Double distEv=Functionalities.distance(latRef, lngRef, eventCopy.get(i).getLocation().getLat(), eventCopy.get(i).getLocation().getLng());</span>
<span class="fc bfc" id="L376" title="All 2 branches covered.">					for(int j=0;j&lt;eventCopy.get(i).getTypes().length;j++) {</span>
<span class="fc bfc" id="L377" title="All 2 branches covered.">						for(String k: u.getTypes()) {</span>
<span class="pc bpc" id="L378" title="1 of 4 branches missed.">								if((s.isEmpty() || !s.get(s.size()-1).getDataOra().toLocalDate().isEqual(eventCopy.get(i).getDataOra().toLocalDate()))) {</span>
									//controllo data
<span class="fc bfc" id="L380" title="All 2 branches covered.">									if(eventCopy.get(i).getTypes()[j].toString().equalsIgnoreCase(k.toString())) {</span>
<span class="fc bfc" id="L381" title="All 2 branches covered.">										if(peso&gt;(1*(0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*(distEv)))) {</span>
<span class="fc" id="L382">											eventChoice=eventCopy.get(i);</span>
<span class="fc" id="L383">											distSel=distEv;</span>
											//System.out.println(&quot;nomeSel:&quot;+eventCopy.get(i).getTitle()+&quot; tipUs:&quot;+k.toString()+&quot; tipSel:&quot;+eventCopy.get(i).getTypes()[j].toString()+&quot; dist:&quot;+distSel+&quot; price:&quot;+eventCopy.get(i).getPrice());
<span class="fc" id="L385">											peso=0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*distEv;</span>
										}
<span class="fc bfc" id="L387" title="All 2 branches covered.">									}else if(Functionalities.similType(eventCopy.get(i).getTypes()[j],k)){</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">										if(peso&gt;(1.5*(0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*distEv))) {</span>
<span class="fc" id="L389">											eventChoice=eventCopy.get(i);</span>
<span class="fc" id="L390">											distSel=distEv;</span>
											//System.out.println(&quot;nomeSel:&quot;+eventCopy.get(i).getTitle()+&quot; tipUs:&quot;+k.toString()+&quot; tipSel:&quot;+eventCopy.get(i).getTypes()[j].toString()+&quot; dist:&quot;+distSel+&quot; price:&quot;+eventCopy.get(i).getPrice());
<span class="fc" id="L392">											peso=1.5*(0.5*(eventCopy.get(i).getPrice()-eventChoice.getPrice())+0.5*distEv);</span>
										}
									}
								}
						}
					}
				}
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">				if(eventChoice!=null)</span>
<span class="fc" id="L400">					s.add(eventChoice);</span>
				else
<span class="nc" id="L402">					choiceNull=true;</span>
			}
			
		}
		
<span class="fc" id="L407">		List&lt;EventResponseTour&gt; eventResponse=new ArrayList&lt;&gt;();</span>
<span class="fc" id="L408">		Double distTot=0.0d;</span>
<span class="fc" id="L409">		Double priceTot=0.0d;</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">		for(int i=0;i&lt;s.size();i++) {</span>
<span class="fc" id="L411">			EventResponseTour et=new EventResponseTour(s.get(i));</span>
<span class="fc bfc" id="L412" title="All 2 branches covered.">			if(i==0)</span>
<span class="fc" id="L413">				distTot+=Functionalities.distance(latU, lngU, s.get(i).getLocation().getLat(), s.get(i).getLocation().getLng());</span>
			else
<span class="fc" id="L415">				distTot+=Functionalities.distance(s.get(i-1).getLocation().getLat(), s.get(i-1).getLocation().getLng(), s.get(i).getLocation().getLat(), s.get(i).getLocation().getLng());</span>
<span class="fc" id="L416">			et.setDistance(distTot);</span>
<span class="fc" id="L417">			et.setPriceTot(et.getPrice()*numPers);</span>
<span class="fc" id="L418">			priceTot+=et.getPriceTot();</span>
<span class="fc" id="L419">			eventResponse.add(et);</span>
		}
<span class="fc" id="L421">		distTot=distTot+Functionalities.distance(s.get(s.size()-1).getLocation().getLat(), s.get(s.size()-1).getLocation().getLng(), latU, lngU);</span>
<span class="fc" id="L422">		EventResponseTourComplete etc=new EventResponseTourComplete(eventResponse,new UserResponse(u), n, eventResponse.size(), priceTot, distTot );</span>
<span class="fc" id="L423">		return new ResponseEntity&lt;&gt;(etc,HttpStatus.OK);</span>
	
		
		
	}


	/**
	 * Sets the account psw.
	 *
	 * @param user the user
	 * @param psw the psw to change
	 * @return the response entity with account
	 */
	public ResponseEntity&lt;AccountResponse&gt; setAccountPsw(String user, String psw) {
<span class="pc bpc" id="L438" title="1 of 2 branches missed.">		if(user.isEmpty()) {</span>
<span class="nc" id="L439">			return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		}
		Object objResp;
		try {
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">			if(Functionalities.isValidEmailAddress(user)) {</span>
<span class="fc" id="L444">			List&lt;Manager&gt; managers = managerRepository.findByMail(user);</span>
<span class="fc bfc" id="L445" title="All 2 branches covered.">				if(managers.isEmpty()) {</span>
<span class="fc" id="L446">						List&lt;User&gt; users = userRepository.findByMail(user);</span>
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">						if(user.isEmpty())</span>
<span class="nc" id="L448">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. invalid mail&quot;),HttpStatus.NOT_ACCEPTABLE);</span>
<span class="fc" id="L449">						users.get(0).setPassword(psw);</span>
<span class="fc" id="L450">						userRepository.save(users.get(0));</span>
<span class="fc" id="L451">						return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;User&quot;,new UserResponse(users.get(0))),HttpStatus.OK);</span>
				}else {
<span class="fc" id="L453">						Request req= requestRepository.findByManagerId(managers.get(0).getId()).get(0);</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">						if(!req.isActive()) {</span>
<span class="nc" id="L455">							return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. no active manager&quot;),HttpStatus.OK);</span>
						}
<span class="fc" id="L457">					    managers.get(0).setPassword(psw);</span>
<span class="fc" id="L458">					    managerRepository.save(managers.get(0));</span>
<span class="fc" id="L459">						objResp=new ManagerPlusResponse(managers.get(0),req);</span>
<span class="fc" id="L460">						return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;Manager&quot;,objResp),HttpStatus.OK);	</span>
				}
			}else {
<span class="nc" id="L463">				return new ResponseEntity&lt;&gt;(new AccountResponse(&quot;NONE&quot;,&quot;ERROR. invalid mail&quot;),HttpStatus.NOT_ACCEPTABLE);</span>
			}
<span class="nc" id="L465">		}catch(Exception e) {</span>
<span class="nc" id="L466">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}


	/**
	 * Send newsletter.
	 *
	 * @return the number of users to whom the newsletter has been sent
	 */
	public Integer sendNews() {
		try {
<span class="fc" id="L478">			List&lt;User&gt; users = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L479">			userRepository.findAll().forEach(users::add);</span>
<span class="pc bpc" id="L480" title="1 of 2 branches missed.">			if(users.isEmpty()) {</span>
<span class="nc" id="L481">				return null;</span>
			}
<span class="fc" id="L483">			int inviate=0;</span>
<span class="fc bfc" id="L484" title="All 2 branches covered.">			for(User user: users) {</span>
<span class="pc bpc" id="L485" title="1 of 2 branches missed.">				if(user.getNewsletter()==null) {</span>
<span class="nc" id="L486">					user.setNewsletter(false);</span>
<span class="nc" id="L487">					userRepository.save(user);</span>
				}
<span class="fc bfc" id="L489" title="All 2 branches covered.">				if(user.getNewsletter()) {</span>
<span class="fc" id="L490">					Page&lt;Event&gt; pageEvents = eventRepository.findByTypesAndLocationRegioneLike(user.getTypes(), user.getResidence().getRegione(), PageRequest.of(0, 5,Sort.by(&quot;dataOra&quot;).ascending()));</span>
<span class="fc" id="L491">					Mail.sendNewsletterMsg(user.getEmail(),pageEvents.getContent());</span>
<span class="fc" id="L492">					inviate++;</span>
				}
			}
<span class="fc" id="L495">			return inviate;</span>
<span class="nc" id="L496">		}catch(Exception e) {</span>
<span class="nc" id="L497">			return null;</span>
		}
	}
	
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span>com.scarcolo.eventour (30 dic 2021 11:11:30)</div></body></html>