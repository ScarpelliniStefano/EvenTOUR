<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>EventService.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">com.scarcolo.eventour (30 dic 2021 11:11:30)</a> &gt; <a href="../../index.html" class="el_group">eventour</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.scarcolo.eventour.service.event</a> &gt; <span class="el_source">EventService.java</span></div><h1>EventService.java</h1><pre class="source lang-java linenums">package com.scarcolo.eventour.service.event;


import org.bson.types.ObjectId;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;

import com.scarcolo.eventour.functions.Functionalities;
import com.scarcolo.eventour.model.event.AddEventRequest;
import com.scarcolo.eventour.model.event.EditEventRequest;
import com.scarcolo.eventour.model.event.Event;
import com.scarcolo.eventour.model.event.EventResponse;
import com.scarcolo.eventour.model.user.User;
import com.scarcolo.eventour.repository.event.EventRepository;
import com.scarcolo.eventour.repository.user.UserRepository;
import com.scarcolo.eventour.service.booking.BookingService;
import com.scarcolo.eventour.service.ticketisp.TicketInspService;

import java.io.IOException;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;


// TODO: Auto-generated Javadoc
/**
 * The Class EventService.
 */
@Service
<span class="fc" id="L43">public class EventService {</span>

    /** The event repository. */
    @Autowired
    private EventRepository eventRepository;
    
    /** The user repository. */
    @Autowired
    private UserRepository userRepository;
    
    /** The booking service. */
    @Autowired
    BookingService bookingService;
    
    /** The ticket service. */
    @Autowired
    TicketInspService ticketService;

   
    /**
     * Add a event.
     *
     * @param request the request of new event
     * @return the response entity with event created
     */
    public ResponseEntity&lt;EventResponse&gt; add(AddEventRequest request){
    	try {
<span class="fc" id="L70">    		Event event = eventRepository.save(new Event(request));</span>
<span class="fc" id="L71">    		return new ResponseEntity&lt;&gt;(new EventResponse(event), HttpStatus.OK);</span>
<span class="fc" id="L72">    	}catch(Exception ex) {</span>
<span class="fc" id="L73">    		return new ResponseEntity&lt;&gt;(HttpStatus.NOT_ACCEPTABLE);</span>
    	}
    }

  
    /**
     * Update a event.
     *
     * @param request the request of update
     * @return the response entity with updated event
     */
    public ResponseEntity&lt;EventResponse&gt; update(EditEventRequest request){
<span class="fc" id="L85">        Optional&lt;Event&gt; optionalEvent = eventRepository.findById(request.id);</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">        if (optionalEvent.isEmpty()) {</span>
<span class="nc" id="L87">            return null;</span>
        }
<span class="fc" id="L89">        Event e=optionalEvent.get();</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if(request.title!=null) {</span>
<span class="fc" id="L91">        	e.setTitle(request.title);</span>
        }
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        if(request.description!=null) {</span>
<span class="fc" id="L94">        	e.setDescription(request.description);</span>
        }
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if(request.dataOra!=null) {</span>
        	try {
<span class="fc" id="L98">				e.setDataOra(Functionalities.convertToDate(request.dataOra));</span>
<span class="pc" id="L99">			} catch (Exception e1) {</span>
<span class="nc" id="L100">				return new ResponseEntity&lt;&gt;(HttpStatus.BAD_REQUEST);</span>
			}
        }
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if(request.location!=null) {</span>
<span class="fc" id="L104">        	e.setLocation(request.location);</span>
        }
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if(request.price!=null) {</span>
<span class="fc" id="L107">        	e.setPrice(request.price);</span>
        }
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        if(request.totSeat!=null) {</span>
<span class="fc" id="L110">        	e.setTotSeat(request.totSeat);</span>
        }
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        if(request.urlImage!=null) {</span>
<span class="fc" id="L113">        	e.setUrlImage(request.urlImage);</span>
        }
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">        if(request.types!=null) {</span>
<span class="fc" id="L116">        	e.setTypes(request.types);</span>
        }
<span class="fc" id="L118">        eventRepository.save(e);</span>
<span class="fc" id="L119">        return new ResponseEntity&lt;&gt;(new EventResponse(e), HttpStatus.OK);</span>
    }

   
    /**
     * Get a event by id.
     *
     * @param id the id
     * @return the event by id
     */
    public ResponseEntity&lt;EventResponse&gt; getById(String id) {
<span class="fc" id="L130">    	Optional&lt;Event&gt; eventData = eventRepository.findById(id);</span>

<span class="fc bfc" id="L132" title="All 2 branches covered.">  	  if (eventData.isPresent()) {</span>
<span class="fc" id="L133">  	    return new ResponseEntity&lt;&gt;(new EventResponse(eventData.get()), HttpStatus.OK);</span>
  	  } else {
<span class="fc" id="L135">  	    return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
  	  }
    }

    /**
     * Delete a event and all bookings and ticket inspectors.
     *
     * @param id the id of event
     * @return true, if successful
     * @throws IOException exception from inputstream file template
     */
    public ResponseEntity&lt;Boolean&gt; delete(String id) throws IOException {
<span class="fc" id="L147">    	Optional&lt;Event&gt; optionalEvent = eventRepository.findById(id);</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (optionalEvent.isEmpty()) {</span>
<span class="nc" id="L149">            return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
        }
<span class="fc" id="L151">        Boolean resp=bookingService.deleteAllBookingFromEvent(optionalEvent.get());</span>
<span class="fc" id="L152">        if(resp==false) {</span>
        	//System.out.println(&quot;error in deleting bookings&quot;);
        }
<span class="fc" id="L155">        resp=ticketService.deleteAllTicketsFromEvent(optionalEvent.get().getId());</span>
<span class="fc" id="L156">        if(resp==false) {</span>
        	//System.out.println(&quot;error in deleting tickets&quot;);
        }
<span class="fc" id="L159">        eventRepository.deleteById(optionalEvent.get().getId());</span>
<span class="fc" id="L160">        return new ResponseEntity&lt;&gt;(true,HttpStatus.OK);</span>
    }

    /**
	 * Get all events.
	 *
	 * @param page the page
	 * @param size the size
	 * @param ordered the order
	 * @param param the parameter to order on
	 * @return all events ordered, if necessary, and divided by page of size
	 */
	public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getAll(int page, int size, String ordered,String param) {
		try {
<span class="fc" id="L174">			List&lt;Event&gt; events = new ArrayList&lt;&gt;();</span>
			
<span class="fc" id="L176">			Pageable paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
			
			Page&lt;Event&gt; pageEvents;
<span class="fc bfc" id="L179" title="All 2 branches covered.">			if(param==null)</span>
<span class="fc" id="L180">					pageEvents=eventRepository.findAllFuture(paging);</span>
			else {
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">				if(ordered.equalsIgnoreCase(&quot;desc&quot;)) {</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">					if(param.equals(&quot;dataOra&quot;)) {</span>
<span class="nc" id="L184">						paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).descending());</span>
<span class="nc" id="L185">						pageEvents=eventRepository.findAllFuture(paging);</span>
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">					}else if(param.equals(&quot;loc&quot;)) {</span>
<span class="fc" id="L187">						paging = PageRequest.of(page, size,Sort.by(&quot;location.regione&quot;,&quot;location.provincia&quot;,&quot;location.city&quot;).descending());</span>
<span class="fc" id="L188">						pageEvents=eventRepository.findAllFuture(paging);</span>
<span class="fc" id="L189">					}else { </span>
<span class="nc" id="L190">						paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).descending());</span>
<span class="nc" id="L191">						pageEvents=eventRepository.findAllFuture(paging);</span>
					}
<span class="nc" id="L193">				}else {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">					if(param.equalsIgnoreCase(&quot;dataOra&quot;)) {</span>
<span class="nc" id="L195">						paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
<span class="nc" id="L196">						pageEvents=eventRepository.findAllFuture(paging);</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">					}else if(param.equals(&quot;loc&quot;)) {</span>
<span class="nc" id="L198">						paging = PageRequest.of(page, size,Sort.by(&quot;location.regione&quot;,&quot;location.provincia&quot;,&quot;location.city&quot;).ascending());</span>
<span class="nc" id="L199">						pageEvents=eventRepository.findAllFuture(paging);</span>
<span class="nc" id="L200">					}else {</span>
<span class="nc" id="L201">						paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
<span class="nc" id="L202">						pageEvents=eventRepository.findAllFuture(paging);</span>
					}
				}
			} 
<span class="fc" id="L206">			events=pageEvents.getContent();	</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">			if(events.isEmpty()) {</span>
<span class="fc" id="L208">				return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
			}
<span class="fc" id="L210">			List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">			for(Event event: events) eventR.add(new EventResponse(event));</span>
<span class="fc" id="L212">			Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L213">			response.put(&quot;events&quot;, eventR);</span>
<span class="fc" id="L214">		    response.put(&quot;currentPage&quot;, pageEvents.getNumber());</span>
<span class="fc" id="L215">		    response.put(&quot;totalItems&quot;, pageEvents.getTotalElements());</span>
<span class="fc" id="L216">		    response.put(&quot;totalPages&quot;, pageEvents.getTotalPages());</span>
			
<span class="fc" id="L218">			return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
<span class="nc" id="L219">		}catch(Exception e) {</span>
<span class="nc" id="L220">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}

	/**
	 * Gets all events by data or interval of data.
	 *
	 * @param page the page
	 * @param size the size
	 * @param dataS the data string
	 * @return the events by data specified
	 */
	public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getByData(int page, int size, String dataS) {
		try {
			Date dataI,dataF;
<span class="fc" id="L235">			List&lt;Event&gt; events = new ArrayList&lt;&gt;(); </span>
<span class="fc" id="L236">            Pageable paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
			Page&lt;Event&gt; pageEvents;
<span class="fc bfc" id="L238" title="All 2 branches covered.">			if(dataS.contains(&quot;,&quot;)) {</span>
<span class="fc" id="L239">				dataI=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(dataS.split(&quot;,&quot;)[0]);</span>
<span class="fc" id="L240">				dataF=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(dataS.split(&quot;,&quot;)[1]);</span>
<span class="fc" id="L241">				Calendar c = Calendar.getInstance(); </span>
<span class="fc" id="L242">			    c.setTime(dataF); </span>
<span class="fc" id="L243">			    c.add(Calendar.DATE, 1);</span>
<span class="fc" id="L244">			    dataF = c.getTime();</span>
				//System.out.println(dataI+&quot; &quot;+dataF);
<span class="fc" id="L246">			}else {</span>
<span class="fc" id="L247">				Date data=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(dataS) ;</span>
<span class="fc" id="L248">				DateFormat formatter = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
<span class="fc" id="L249">			    dataI = formatter.parse(formatter.format(data));</span>
<span class="fc" id="L250">			    Calendar c = Calendar.getInstance(); </span>
<span class="fc" id="L251">			    c.setTime(dataI); </span>
<span class="fc" id="L252">			    c.add(Calendar.DATE, 1);</span>
<span class="fc" id="L253">			    dataF = c.getTime();</span>
<span class="fc" id="L254">			    dataF = formatter.parse(formatter.format(dataF));</span>
			}
			
<span class="fc" id="L257">			pageEvents=eventRepository.findByDataOraBetweenOrderByDataOraAsc(dataI, dataF,paging);</span>
<span class="fc" id="L258">			events=pageEvents.getContent();</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">	  	  if (events.isEmpty()) {</span>
<span class="nc" id="L260">	  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
	  	  } 
<span class="fc" id="L262">	  	  List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">		  for(Event event: events) eventR.add(new EventResponse(event));</span>
<span class="fc" id="L264">		  Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L265">		  response.put(&quot;events&quot;, eventR);</span>
<span class="fc" id="L266">		  response.put(&quot;currentPage&quot;, pageEvents.getNumber());</span>
<span class="fc" id="L267">		  response.put(&quot;totalItems&quot;, pageEvents.getTotalElements());</span>
<span class="fc" id="L268">		  response.put(&quot;totalPages&quot;, pageEvents.getTotalPages());</span>
<span class="fc" id="L269">		  return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
	  	  
<span class="nc" id="L271">		}catch(Exception e) {</span>
<span class="nc" id="L272">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}


	/**
	 * Gets all events by location.
	 *
	 * @param page the page
	 * @param size the size
	 * @param loc the location name
	 * @param type the type of location (regione, provincia, city)
	 * @return the all events by location
	 */
	public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getByLoc(int page, int size, String loc, String type) {
		try {
<span class="fc" id="L288">			List&lt;Event&gt; events = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L289">			Pageable paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
			
			Page&lt;Event&gt; pageEvents;
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">			if(type.equalsIgnoreCase(&quot;regione&quot;)) {</span>
<span class="nc" id="L293">				pageEvents = eventRepository.findByLocationLike(&quot;location.regione&quot;,loc,paging);</span>
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">			}else if(type.equalsIgnoreCase(&quot;provincia&quot;)) {</span>
<span class="fc" id="L295">				pageEvents = eventRepository.findByLocationLike(&quot;location.provincia&quot;,loc,paging);</span>
<span class="pc bnc" id="L296" title="All 2 branches missed.">			}else if(type.equalsIgnoreCase(&quot;city&quot;)) {</span>
<span class="nc" id="L297">				pageEvents = eventRepository.findByLocationLike(&quot;location.city&quot;,loc,paging);</span>
<span class="nc" id="L298">			}else {</span>
<span class="nc" id="L299">				pageEvents=eventRepository.findAll(paging);</span>
			}
<span class="fc" id="L301">			events=pageEvents.getContent();</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">		  	if (events.isEmpty()) {</span>
<span class="nc" id="L303">		  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		  	} 
<span class="fc" id="L305">		  	List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">			for(Event event: events) eventR.add(new EventResponse(event));</span>
<span class="fc" id="L307">			Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L308">			response.put(&quot;events&quot;, eventR);</span>
<span class="fc" id="L309">			response.put(&quot;currentPage&quot;, pageEvents.getNumber());</span>
<span class="fc" id="L310">			response.put(&quot;totalItems&quot;, pageEvents.getTotalElements());</span>
<span class="fc" id="L311">			response.put(&quot;totalPages&quot;, pageEvents.getTotalPages());</span>
<span class="fc" id="L312">			return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
		  	  
<span class="nc" id="L314">		}catch(Exception e) {</span>
<span class="nc" id="L315">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}


	/**
	 * Gets all events by preferences.
	 *
	 * @param page the page
	 * @param size the size
	 * @param idPref the id of user
	 * @param locInclude true if location is included in filter the events
	 * @return the events by preferences
	 */
	public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getByPreferences(int page, int size, String idPref, boolean locInclude) {
<span class="fc" id="L330">		Optional&lt;User&gt; userData = userRepository.findById(idPref);</span>

<span class="pc bpc" id="L332" title="1 of 2 branches missed.">	  	  if (userData.isPresent()) {</span>
<span class="fc bfc" id="L333" title="All 2 branches covered.">	  		  if(!locInclude)</span>
<span class="fc" id="L334">	  			  return this.getByTypes(page, size, Arrays.toString(userData.get().getTypes()).replace(&quot; &quot;, &quot;&quot;).replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;));</span>
	  		  else
<span class="fc" id="L336">	  			  return this.getByTypesWithLoc(page, size, userData.get().getTypes(),userData.get().getResidence().getRegione());</span>
	  	  } else {
<span class="nc" id="L338">	  	    return new ResponseEntity&lt;&gt;(HttpStatus.NOT_FOUND);</span>
	  	  }
		
	}


	/**
	 * Gets all events by types with location filtered.
	 *
	 * @param page the page
	 * @param size the size
	 * @param types the types
	 * @param region the region to witch filter
	 * @return all event by types with location
	 */
	private ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getByTypesWithLoc(int page, int size, String[] types, String region) {
		try {
<span class="fc" id="L355">			Pageable paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
			Page&lt;Event&gt; pageEvents;
<span class="fc" id="L357">			pageEvents = eventRepository.findByTypesAndLocationRegioneLike(types,region,paging);</span>
<span class="fc" id="L358">			List&lt;Event&gt; events=pageEvents.getContent();</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">		  	  if (events.isEmpty()) {</span>
<span class="nc" id="L360">		  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		  	  } 
<span class="fc" id="L362">		  	  List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">			  for(Event event: events) eventR.add(new EventResponse(event));</span>
<span class="fc" id="L364">			  Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L365">			  response.put(&quot;events&quot;, eventR);</span>
<span class="fc" id="L366">			  response.put(&quot;currentPage&quot;, pageEvents.getNumber());</span>
<span class="fc" id="L367">			  response.put(&quot;totalItems&quot;, pageEvents.getTotalElements());</span>
<span class="fc" id="L368">			  response.put(&quot;totalPages&quot;, pageEvents.getTotalPages());</span>
<span class="fc" id="L369">			  return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
			  
<span class="nc" id="L371">			}catch(Exception e) {</span>
<span class="nc" id="L372">				return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
			}
	}


	/**
	 * Gets all events by types.
	 *
	 * @param page the page
	 * @param size the size
	 * @param type the types array
	 * @return all event of a given types
	 */
	public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getByTypes(int page, int size, String type) {
		try {
<span class="fc" id="L387">			String[] types=type.split(&quot;,&quot;);</span>
<span class="fc" id="L388">			Pageable paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
			
			Page&lt;Event&gt; pageEvents;
<span class="fc" id="L391">			pageEvents = eventRepository.findByTypes(types,paging);</span>
<span class="fc" id="L392">			List&lt;Event&gt; events=pageEvents.getContent();</span>
<span class="pc bpc" id="L393" title="1 of 2 branches missed.">		  	  if (events.isEmpty()) {</span>
<span class="nc" id="L394">		  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		  	  } 
<span class="fc" id="L396">		  	  List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">			  for(Event event: events) eventR.add(new EventResponse(event));</span>
<span class="fc" id="L398">			  Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L399">			  response.put(&quot;events&quot;, eventR);</span>
<span class="fc" id="L400">			  response.put(&quot;currentPage&quot;, pageEvents.getNumber());</span>
<span class="fc" id="L401">			  response.put(&quot;totalItems&quot;, pageEvents.getTotalElements());</span>
<span class="fc" id="L402">			  response.put(&quot;totalPages&quot;, pageEvents.getTotalPages());</span>
<span class="fc" id="L403">			  return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
			  
<span class="nc" id="L405">			}catch(Exception e) {</span>
<span class="nc" id="L406">				return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
			}
	}


	/**
	 * Gets all events by id manager.
	 *
	 * @param page the page
	 * @param size the size
	 * @param id the id manager
	 * @return page required of size with the events
	 */
	public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getByIdMan(int page, int size, String id) {
		try {
<span class="fc" id="L421">			Pageable paging = PageRequest.of(page, size,Sort.by(&quot;dataOra&quot;).ascending());</span>
			Page&lt;Event&gt; pageEvents;
<span class="fc" id="L423">			pageEvents=eventRepository.findByManagerId(new ObjectId(id),paging);</span>
<span class="fc" id="L424">			List&lt;Event&gt; events=pageEvents.getContent();</span>
<span class="fc bfc" id="L425" title="All 2 branches covered.">			if(events.isEmpty()) {</span>
<span class="fc" id="L426">				return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
			}
<span class="fc" id="L428">			List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">			for(Event event: events) {</span>
<span class="fc" id="L430">				eventR.add(new EventResponse(event));</span>
			}
<span class="fc" id="L432">			Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L433">			response.put(&quot;events&quot;, eventR);</span>
<span class="fc" id="L434">			response.put(&quot;currentPage&quot;, pageEvents.getNumber());</span>
<span class="fc" id="L435">			response.put(&quot;totalItems&quot;, pageEvents.getTotalElements());</span>
<span class="fc" id="L436">			response.put(&quot;totalPages&quot;, pageEvents.getTotalPages());</span>
<span class="fc" id="L437">			return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
<span class="nc" id="L438">		}catch(Exception e) {</span>
<span class="nc" id="L439">			return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
		}
	}


	/**
	 * Gets all events with free seats.
	 *
	 * @param page the page
	 * @param size the size
	 * @return the events with free seats
	 */
	public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; getEventsDisp(int page, int size) {
		try {
			
<span class="fc" id="L454">			Sort sort = Sort.by(&quot;dataOra&quot;).ascending().and(Sort.by(&quot;freeSeat&quot;).ascending());</span>
<span class="fc" id="L455">			Pageable paging = PageRequest.of(page, size,sort);</span>
			Page&lt;Event&gt; pageEvents;
<span class="fc" id="L457">			pageEvents = eventRepository.findByFreeSeatGreaterThanZero(paging);</span>
<span class="fc" id="L458">			List&lt;Event&gt; events=pageEvents.getContent();</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">		  	if (events.isEmpty()) {</span>
<span class="nc" id="L460">		  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
		  	} 
<span class="fc" id="L462">		  	List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L463" title="All 2 branches covered.">			for(Event event: events) eventR.add(new EventResponse(event));</span>
<span class="fc" id="L464">			Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span>
<span class="fc" id="L465">			response.put(&quot;events&quot;, eventR);</span>
<span class="fc" id="L466">			response.put(&quot;currentPage&quot;, pageEvents.getNumber());</span>
<span class="fc" id="L467">			response.put(&quot;totalItems&quot;, pageEvents.getTotalElements());</span>
<span class="fc" id="L468">			response.put(&quot;totalPages&quot;, pageEvents.getTotalPages());</span>
<span class="fc" id="L469">			return new ResponseEntity&lt;&gt;(response, HttpStatus.OK);</span>
		  	  
<span class="nc" id="L471">			}catch(Exception e) {</span>
<span class="nc" id="L472">				return new ResponseEntity&lt;&gt;(HttpStatus.INTERNAL_SERVER_ERROR);</span>
			}
	}


	

	  /*
	   * API OF EVENTS WITHOUT PAGE AND SIZE, BUT WITH SAME SIGNATURE
	   *
	public ResponseEntity&lt;List&lt;EventResponse&gt;&gt; getAll(String ordered, String param) {
		try {
			List&lt;Event&gt; events = new ArrayList&lt;&gt;();

			if(param==null)
					eventRepository.findAll().forEach(events::add);
			else {
				if(ordered.equalsIgnoreCase(&quot;desc&quot;)) {
					if(param.equals(&quot;dataOra&quot;)) {
						eventRepository.findAll(Sort.by(&quot;dataOra&quot;).descending()).forEach(events::add);
					}else if(param.equals(&quot;loc&quot;)) {
						eventRepository.findAll(Sort.by(&quot;location.regione&quot;,&quot;location.provincia&quot;,&quot;location.city&quot;).descending()).forEach(events::add);
					}else { 
						eventRepository.findAll(Sort.by(&quot;dataOra&quot;).descending()).forEach(events::add);
					}
				}else {
					if(param.equalsIgnoreCase(&quot;dataOra&quot;)) {
						eventRepository.findAll(Sort.by(&quot;dataOra&quot;).ascending()).forEach(events::add);
					}else if(param.equals(&quot;loc&quot;)) {
						eventRepository.findAll(Sort.by(&quot;location.regione&quot;,&quot;location.provincia&quot;,&quot;location.city&quot;).ascending()).forEach(events::add);
					}else {
						eventRepository.findAll(Sort.by(&quot;dataOra&quot;).ascending()).forEach(events::add);
					}
				}
			} 
			if(events.isEmpty()) {
				return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);
			}
			List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();
			for(Event event: events) eventR.add(new EventResponse(event));
			return new ResponseEntity&lt;&gt;(eventR, HttpStatus.OK);
		}catch(Exception e) {
			return new ResponseEntity&lt;&gt;(null, HttpStatus.INTERNAL_SERVER_ERROR);
		}
	}


	public ResponseEntity&lt;List&lt;EventResponse&gt;&gt; getByData(String dataS) {
		try {
			Date dataI,dataF;
			List&lt;Event&gt; events = new ArrayList&lt;&gt;(); 

			if(dataS.contains(&quot;,&quot;)) {
				dataI=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(dataS.split(&quot;,&quot;)[0]);
				dataF=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(dataS.split(&quot;,&quot;)[1]);
			}else {
				Date data=new SimpleDateFormat(&quot;yyyy-MM-dd&quot;).parse(dataS) ;
				DateFormat formatter = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);
			    dataI = formatter.parse(formatter.format(data));
			    Calendar c = Calendar.getInstance(); 
			    c.setTime(dataI); 
			    c.add(Calendar.DATE, 1);
			    dataF = c.getTime();
			    dataF = formatter.parse(formatter.format(dataF));
			}
			
			eventRepository.findByDataOraBetweenOrderByDataOraAsc(dataI, dataF).forEach(events::add);

	  	  if (events.isEmpty()) {
	  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);
	  	  } 
	  	  List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();
		  for(Event event: events) eventR.add(new EventResponse(event));
		  return new ResponseEntity&lt;&gt;(eventR, HttpStatus.OK);
	  	  
		}catch(Exception e) {
			return new ResponseEntity&lt;&gt;(null, HttpStatus.INTERNAL_SERVER_ERROR);
		}
	}


	public ResponseEntity&lt;List&lt;EventResponse&gt;&gt; getByLoc(String loc, String type) {
		try {
			List&lt;Event&gt; events = new ArrayList&lt;&gt;();
			if(type.equalsIgnoreCase(&quot;regione&quot;)) {
				events = eventRepository.findByLocationLike(&quot;location.regione&quot;,loc);
			}else if(type.equalsIgnoreCase(&quot;provincia&quot;)) {
				events = eventRepository.findByLocationLike(&quot;location.provincia&quot;,loc);
			}else if(type.equalsIgnoreCase(&quot;city&quot;)) {
				events = eventRepository.findByLocationLike(&quot;location.city&quot;,loc);
			}else {
				System.out.println(&quot;else&quot;);
				eventRepository.findAll().forEach(events::add);
			}
		  	if (events.isEmpty()) {
		  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);
		  	} 
		  	List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();
			for(Event event: events) eventR.add(new EventResponse(event));
			return new ResponseEntity&lt;&gt;(eventR, HttpStatus.OK);
		  	  
		}catch(Exception e) {
			return new ResponseEntity&lt;&gt;(null, HttpStatus.INTERNAL_SERVER_ERROR);
		}
	}


	public ResponseEntity&lt;List&lt;EventResponse&gt;&gt; getByTypes(String type) {
		try {
			String[] types=type.split(&quot;,&quot;);
			List&lt;Event&gt; events = eventRepository.findByTypes(types);

		  	  if (events.isEmpty()) {
		  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);
		  	  } 
		  	  List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();
			  for(Event event: events) eventR.add(new EventResponse(event));
			  return new ResponseEntity&lt;&gt;(eventR, HttpStatus.OK);
		  	  
			}catch(Exception e) {
				return new ResponseEntity&lt;&gt;(null, HttpStatus.INTERNAL_SERVER_ERROR);
			}
	}


	public ResponseEntity&lt;List&lt;EventResponse&gt;&gt; getByPreferences(String pref) {
		return this.getByTypes(pref);
	}


	public ResponseEntity&lt;List&lt;EventResponse&gt;&gt; getByIdMan(String id) {
		try {

			List&lt;Event&gt; events=eventRepository.findByManagerId(id);

			if(events.isEmpty()) {
				return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);
			}
			List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();
			for(Event event: events) {
				eventR.add(new EventResponse(event));
			}
			return new ResponseEntity&lt;&gt;(eventR, HttpStatus.OK);
		}catch(Exception e) {
			return new ResponseEntity&lt;&gt;(null, HttpStatus.INTERNAL_SERVER_ERROR);
		}
	}


	public ResponseEntity&lt;List&lt;EventResponse&gt;&gt; getEventsDisp() {
		try {
			Sort sort = Sort.by(&quot;freeSeat&quot;).ascending().and(Sort.by(&quot;title&quot;).ascending());
			List&lt;Event&gt; events = eventRepository.findByfreeSeatGreaterThanZero(sort);
		  	  if (events.isEmpty()) {
		  	    return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);
		  	  } 
		  	  List&lt;EventResponse&gt; eventR= new ArrayList&lt;&gt;();
			  for(Event event: events) eventR.add(new EventResponse(event));
			  return new ResponseEntity&lt;&gt;(eventR, HttpStatus.OK);
		  	  
			}catch(Exception e) {
				return new ResponseEntity&lt;&gt;(null, HttpStatus.INTERNAL_SERVER_ERROR);
			}
	}
	
	*/


	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span>com.scarcolo.eventour (30 dic 2021 11:11:30)</div></body></html>